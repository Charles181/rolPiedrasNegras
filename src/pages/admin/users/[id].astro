---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { db, User, Account, eq, and } from "astro:db";
import { hashPassword } from "../../../lib/auth";

const { user } = Astro.locals;
const { id } = Astro.params;

if (!user || user.role !== "admin") return Astro.redirect("/");

const targetUser = await db.select().from(User).where(eq(User.id, id)).get();
if (!targetUser) return Astro.redirect("/admin/users");

let message = "";
let msgType = ""; // success or error

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action");

    try {
        if (action === "update_role") {
            const newRole = formData.get("role") as string;
            await db.update(User).set({ role: newRole }).where(eq(User.id, id));
            message = "Rol actualizado correctamente.";
            msgType = "success";
            // Update local object to reflect change
            targetUser.role = newRole;
        } else if (action === "reset_password") {
            const newPass = formData.get("password") as string;
            if (newPass && newPass.length >= 6) {
                const hashed = await hashPassword(newPass);
                // Update Account
                // Assuming credential provider. If multiple accounts, this might be tricky, but usually one credential account per user.
                // We'll update any account linked to user where provider is credential, or just update all?
                // Safest: Update account where userId = id AND providerId = 'credential'

                const account = await db
                    .select()
                    .from(Account)
                    .where(
                        and(
                            eq(Account.userId, id),
                            eq(Account.providerId, "credential"),
                        ),
                    )
                    .get();

                if (account) {
                    await db
                        .update(Account)
                        .set({ password: hashed })
                        .where(eq(Account.id, account.id));
                    message = "Contraseña restablecida correctamente.";
                    msgType = "success";
                } else {
                    // Create credential account if missing?
                    // Let's create one.
                    await db.insert(Account).values({
                        id: crypto.randomUUID(),
                        userId: id,
                        accountId: targetUser.email,
                        providerId: "credential",
                        password: hashed,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                    });
                    message =
                        "Cuenta de credenciales creada y contraseña establecida.";
                    msgType = "success";
                }
            } else {
                message = "La contraseña debe tener al menos 6 caracteres.";
                msgType = "error";
            }
        }
    } catch (e) {
        console.error(e);
        message = "Ocurrió un error.";
        msgType = "error";
    }
}
---

<AdminLayout title={`Editar Usuario: ${targetUser.name}`}>
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold font-serif text-white">
                Editar Usuario
            </h1>
            <a href="/admin/users" class="text-slate-400 hover:text-white"
                >← Volver</a
            >
        </div>

        {
            message && (
                <div
                    class={`p-4 rounded mb-6 border ${msgType === "success" ? "bg-green-900/50 text-green-200 border-green-500/30" : "bg-red-900/50 text-red-200 border-red-500/30"}`}
                >
                    {message}
                </div>
            )
        }

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- User Info & Role -->
            <div
                class="bg-slate-800 rounded-lg p-6 border border-slate-700 shadow-xl"
            >
                <h2 class="text-xl font-bold text-white mb-4">
                    Información General
                </h2>
                <div class="flex items-center gap-4 mb-6">
                    {
                        targetUser.image ? (
                            <img
                                src={targetUser.image}
                                class="w-16 h-16 rounded-full"
                            />
                        ) : (
                            <div class="w-16 h-16 rounded-full bg-slate-600 flex items-center justify-center text-2xl font-bold text-white">
                                {targetUser.name[0]}
                            </div>
                        )
                    }
                    <div>
                        <p class="font-bold text-lg text-white">
                            {targetUser.name}
                        </p>
                        <p class="text-slate-400">{targetUser.email}</p>
                    </div>
                </div>

                <form method="POST" class="space-y-4">
                    <input type="hidden" name="action" value="update_role" />
                    <div>
                        <label class="block text-sm text-slate-400 mb-1"
                            >Rol del Usuario</label
                        >
                        <select
                            name="role"
                            class="w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2"
                        >
                            <option
                                value="user"
                                selected={targetUser.role === "user"}
                                >Usuario (Jugador)</option
                            >
                            <option
                                value="master"
                                selected={targetUser.role === "master"}
                                >Master (Narrador)</option
                            >
                            <option
                                value="admin"
                                selected={targetUser.role === "admin"}
                                >Administrador</option
                            >
                        </select>
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded transition-colors"
                    >
                        Actualizar Rol
                    </button>
                </form>
            </div>

            <!-- Reset Password -->
            <div
                class="bg-slate-800 rounded-lg p-6 border border-slate-700 shadow-xl"
            >
                <h2 class="text-xl font-bold text-white mb-4">Seguridad</h2>
                <p class="text-sm text-slate-400 mb-4">
                    Restablecer la contraseña del usuario manualmente. Esta
                    acción es irreversible.
                </p>

                <form method="POST" class="space-y-4">
                    <input type="hidden" name="action" value="reset_password" />
                    <div>
                        <label class="block text-sm text-slate-400 mb-1"
                            >Nueva Contraseña</label
                        >
                        <input
                            type="password"
                            name="password"
                            minlength="6"
                            required
                            class="w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2"
                            placeholder="Mínimo 6 caracteres"
                        />
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 rounded transition-colors"
                    >
                        Restablecer Contraseña
                    </button>
                </form>
            </div>
        </div>
    </div>
</AdminLayout>
