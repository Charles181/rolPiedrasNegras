---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { createUser } from "../../../lib/auth";

const { user } = Astro.locals;
if (!user || user.role !== "admin") return Astro.redirect("/");

let error = "";
let success = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const name = formData.get("name") as string;
    const email = formData.get("email") as string;
    const password = formData.get("password") as string;
    const role = formData.get("role") as string;

    if (!name || !email || !password || !role) {
        error = "Todos los campos son obligatorios.";
    } else {
        try {
            await createUser(email, password, name, role);
            success = "Usuario creado exitosamente.";
            return Astro.redirect("/admin/users");
        } catch (e: any) {
            if (e.message && e.message.includes("UNIQUE constraint")) {
                error = "El correo electr칩nico ya est치 registrado.";
            } else {
                console.error(e);
                error = "Error al crear usuario.";
            }
        }
    }
}
---

<AdminLayout title="Agregar Usuario">
    <div class="max-w-2xl mx-auto">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-3xl font-bold font-serif text-white">
                Agregar Usuario
            </h1>
            <a href="/admin/users" class="text-slate-400 hover:text-white"
                >Cancelar</a
            >
        </div>

        <div
            class="bg-slate-800 rounded-lg p-6 border border-slate-700 shadow-xl"
        >
            {
                error && (
                    <div class="bg-red-900/50 text-red-200 p-4 rounded mb-6 border border-red-500/30">
                        {error}
                    </div>
                )
            }
            {
                success && (
                    <div class="bg-green-900/50 text-green-200 p-4 rounded mb-6 border border-green-500/30">
                        {success}
                    </div>
                )
            }

            <form method="POST" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300"
                        >Nombre Completo</label
                    >
                    <input
                        type="text"
                        name="name"
                        required
                        class="mt-1 w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2 focus:ring-cyan-500 focus:border-cyan-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300"
                        >Correo Electr칩nico</label
                    >
                    <input
                        type="email"
                        name="email"
                        required
                        class="mt-1 w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2 focus:ring-cyan-500 focus:border-cyan-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300"
                        >Contrase침a</label
                    >
                    <input
                        type="password"
                        name="password"
                        required
                        class="mt-1 w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2 focus:ring-cyan-500 focus:border-cyan-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300"
                        >Rol</label
                    >
                    <select
                        name="role"
                        class="mt-1 w-full bg-slate-900 border-slate-600 rounded text-white px-3 py-2 focus:ring-cyan-500 focus:border-cyan-500"
                    >
                        <option value="user">Usuario (Jugador)</option>
                        <option value="master">Master (Narrador)</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="pt-4">
                    <button
                        type="submit"
                        class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded shadow-lg transition-colors"
                    >
                        Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</AdminLayout>
