---
import AdminLayout from "../../../../layouts/AdminLayout.astro";
import PostEditor from "../../../../components/PostEditor";
import { db, Post, eq } from "astro:db";

const { id } = Astro.params;
const { user } = Astro.locals;

if (!user || (user.role !== "admin" && user.role !== "master")) {
    return Astro.redirect("/login");
}

if (!id) {
    return Astro.redirect("/admin/posts");
}

const posts = await db
    .select()
    .from(Post)
    .where(eq(Post.id, Number(id)));
const post = posts[0];

if (!post) {
    return Astro.redirect("/admin/posts");
}

const initialData = {
    id: post.id,
    title: post.title,
    category: post.category,
    image: post.image, // Ensure null is handled if db returns null. PostEditor expects string | null | undefined
    body: post.body,
    type: post.type as "post" | "rule",
};
---

<AdminLayout title="Edit Content">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white">Editar Contenido</h1>
            <p class="text-gray-400">Actualizar contenido existente.</p>
        </div>

        <PostEditor client:only="react" initialData={initialData} />
    </div>
</AdminLayout>
