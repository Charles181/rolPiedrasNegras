---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { db, Campaign, eq, desc } from "astro:db";

const { user } = Astro.locals;
if (!user) return Astro.redirect("/");

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action");
    const id = formData.get("id");

    if (action === "delete" && typeof id === "string") {
        await db.delete(Campaign).where(eq(Campaign.id, id));
    }
}

// Filter campaigns based on role
let campaigns = [];
if (user.role === "admin") {
    campaigns = await db
        .select()
        .from(Campaign)
        .orderBy(desc(Campaign.createdAt));
} else {
    // Master
    campaigns = await db
        .select()
        .from(Campaign)
        .where(eq(Campaign.masterId, user.id))
        .orderBy(desc(Campaign.createdAt));
}
---

<AdminLayout title="Gestión de Campañas">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold font-serif text-white">
                Gestión de Campañas
            </h1>
            <p class="text-slate-400 mt-1">
                {
                    user.role === "admin"
                        ? "Viendo todas las campañas del sistema"
                        : "Viendo tus campañas creadas"
                }
            </p>
        </div>
        <a
            href="/admin/campaigns/create"
            class="bg-cyan-600 text-white px-4 py-2 rounded-md hover:bg-cyan-700 shadow-lg shadow-cyan-900/20 transition-colors flex items-center gap-2"
        >
            <span class="text-lg">+</span> Nueva Campaña
        </a>
    </div>

    <div
        class="bg-slate-800 shadow-xl rounded-lg overflow-hidden border border-slate-700"
    >
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-900/50">
                    <tr>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider"
                            >Nombre</th
                        >
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider"
                            >Sistema</th
                        >
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider"
                            >Próx. Sesión</th
                        >
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider"
                            >Estado</th
                        >
                        <th
                            class="px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider"
                            >Acciones</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700 bg-slate-800">
                    {
                        campaigns.length > 0 ? (
                            campaigns.map((campaign) => (
                                <tr class="hover:bg-slate-700/50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-white">
                                            {campaign.name}
                                        </div>
                                        <div class="text-xs text-slate-400 max-w-xs truncate">
                                            {campaign.description}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                                        {campaign.system || "N/A"}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                                        {campaign.nextSession
                                            ? campaign.nextSession.toLocaleDateString()
                                            : "-"}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span
                                            class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${campaign.status === "ongoing" ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800"}`}
                                        >
                                            {campaign.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a
                                            href={`/admin/campaigns/${campaign.id}`}
                                            class="text-cyan-400 hover:text-cyan-300 mr-3"
                                        >
                                            Administrar
                                        </a>
                                        <form
                                            method="POST"
                                            action="/admin/campaigns"
                                            class="inline-block"
                                            onsubmit="return confirm('Estas seguro que deseas eliminar el post/campaña?');"
                                        >
                                            <input
                                                type="hidden"
                                                name="action"
                                                value="delete"
                                            />
                                            <input
                                                type="hidden"
                                                name="id"
                                                value={campaign.id}
                                            />
                                            <button
                                                type="submit"
                                                class="text-red-400 hover:text-red-300 transition-colors"
                                            >
                                                Eliminar
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td
                                    colspan="5"
                                    class="px-6 py-10 text-center text-slate-400"
                                >
                                    No hay campañas registradas.
                                </td>
                            </tr>
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>
</AdminLayout>
